#!/bin/sh

CODE_SERVER_BIN="/usr/lib/code-server/bin/code-server"
DATA_DIR="/work/vscode"
mkdir -p $DATA_DIR/data $DATA_DIR/ext

pids=$(ps aux | grep 'code-server' | grep -v grep | awk '{print $2}')

if [ -n "$pids" ]; then
    echo "Killing code-server processes: $pids"
    echo $pids | xargs kill -9
else
    echo "No code-server processes found"
fi

# Start code-server with necessary options
exec "$CODE_SERVER_BIN" --auth none --disable-telemetry --disable-update-check \
    --bind-addr 0.0.0.0:8080 \
    --config $DATA_DIR/config.yml \
    --user-data-dir $DATA_DIR/data \
    --extensions-dir $DATA_DIR/ext
