#!/bin/sh
set -e

DATA_DIR="/work/vscode"
BIND_ADDR="${1:-0.0.0.0:8080}"

log() { echo "[VSCODE] $1"; }

# 停止已存在的进程
stop_existing() {
    pids=$(ps aux | grep 'code-server' | grep -v grep | awk '{print $2}' || true)
    [ -n "$pids" ] && echo "$pids" | xargs kill -9 2>/dev/null || true
}

stop_existing
mkdir -p "$DATA_DIR/data" "$DATA_DIR/ext"
log "Starting code-server on $BIND_ADDR..."
exec /usr/lib/code-server/bin/code-server \
    --auth none \
    --disable-telemetry \
    --disable-update-check \
    --bind-addr "$BIND_ADDR" \
    --config "$DATA_DIR/config.yml" \
    --user-data-dir "$DATA_DIR/data" \
    --extensions-dir "$DATA_DIR/ext"
