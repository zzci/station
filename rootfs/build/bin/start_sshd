#!/bin/sh
set -e

SSHD_CONFIG_DIR="/work/config/sshd"

log() { echo "[SSHD] $1"; }

# 初始化 SSH 密钥
init_ssh_keys() {
    log "Initializing SSH host keys..."
    for key_type in dsa rsa ecdsa ed25519; do
        key_file="$SSHD_CONFIG_DIR/ssh_host_${key_type}_key"
        [ ! -f "$key_file" ] && ssh-keygen -q -N "" -t "$key_type" -f "$key_file"
        rm -f "/etc/ssh/ssh_host_${key_type}_key" "/etc/ssh/ssh_host_${key_type}_key.pub"
        ln -sf "$key_file" "/etc/ssh/ssh_host_${key_type}_key"
        ln -sf "${key_file}.pub" "/etc/ssh/ssh_host_${key_type}_key.pub"
    done
}

# 初始化配置
init_config() {
    mkdir -p /run/sshd "$SSHD_CONFIG_DIR"
    [ ! -f "$SSHD_CONFIG_DIR/sshd_config" ] && cp -a /build/config/sshd/sshd_config "$SSHD_CONFIG_DIR/"
    rm -f /etc/ssh/sshd_config
    ln -sf "$SSHD_CONFIG_DIR/sshd_config" /etc/ssh/sshd_config
    # 随机 root 密码
    echo "root:$(cat /dev/urandom | base64 | head -c 16)" | chpasswd
}

init_config
init_ssh_keys
log "Starting sshd..."
exec /usr/sbin/sshd -D -E /var/log/sshd.log
